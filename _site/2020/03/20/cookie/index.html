<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title> cookie 及其替代方案 &mdash; sunseekers</title><link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css" /><link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css" /><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css" /><link rel="canonical" href="http://localhost:4000/2020/03/20/cookie/" /><link rel="alternate" type="application/atom+xml" title="sunseekers" href="http://localhost:4000/feed.xml" /><link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /><meta property="og:title" content="cookie 及其替代方案" /><meta name="keywords" content="cookie" /><meta name="og:keywords" content="cookie" /><meta name="description" content="本地有效期存储数据" /><meta name="og:description" content="本地有效期存储数据" /><meta property="og:url" content="http://localhost:4000/2020/03/20/cookie/" /><meta property="og:site_name" content="sunseekers" /><meta property="og:type" content="article" /><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2020-03-20" /> <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="http://localhost:4000/assets/js/jquery-ui.js"></script> <script src="http://localhost:4000/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1> <a href="http://localhost:4000/" title="sunseekers" ><span class="octicon octicon-mark-github"></span> sunseekers</a ></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();" > <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页" >首页</a > <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类" >分类</a > <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="感谢" >感谢</a > <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于" >关于</a ></nav></div></header><style> html.dark-mode, html.dark-mode img { filter: invert(1) hue-rotate(180deg); } html.dark-mode img { opacity: 0.85; } /* 关闭了深色模式，因为布局有问题 */ #darkContainer { position: fixed; bottom: 50px; left: 100px; display: flex; display: none; } #darkContainer .text { margin-right: 8px; } #darkContainer .switch-btn { user-select: none; display: inline-block; width: 50px; border: none; height: 25px; border-radius: 50px; background: rgba(0, 0, 0, 0.25); cursor: pointer; transition: all 0.2s; position: relative; outline: none; } #darkContainer .switch-btn.switch-btn-checked { background: #1890ff; } #darkContainer .switch-btn .switch-handle { height: 20px; width: 20px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 4px; transition: all 0.2s ease-in-out; } #darkContainer .switch-btn.switch-btn-checked .switch-handle { left: calc(100% - 22px); }</style><script> let isDarkMode = localStorage.getItem('isDarkMode'); if (isDarkMode === 'true') { document.firstElementChild.classList.add('dark-mode'); } </script> <script defer> const darkContainer = document.createElement('div'); darkContainer.id = 'darkContainer'; darkContainer.innerHTML = `<span class="text">深色模式</span>`; const btnEl = document.createElement('button'); btnEl.classList.add('switch-btn'); btnEl.innerHTML = `<div class="switch-handle"></div>`; if (isDarkMode === 'true') { btnEl.classList.add('switch-btn-checked'); } btnEl.addEventListener('click', (e) => { if (btnEl.classList.contains('switch-btn-checked')) { btnEl.classList.remove('switch-btn-checked'); document.firstElementChild.classList.remove('dark-mode'); localStorage.setItem('isDarkMode', 'false'); } else { btnEl.classList.add('switch-btn-checked'); document.firstElementChild.classList.add('dark-mode'); localStorage.setItem('isDarkMode', 'true'); } }); darkContainer.append(btnEl); document.body.appendChild(darkContainer); </script></body></html><section class="collection-head small geopattern" data-pattern-id="cookie 及其替代方案" ><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">cookie 及其替代方案</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2020/03/20 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#功能实现" title="功能实现" >功能实现</a > </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 3537 字，约 11 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths"><article class="article-content markdown-body"><h1 id="本地有效期存储数据">本地有效期存储数据</h1><p>记录 cookie 的概念，设置获取删除</p><h2 id="cookie-概念"><code class="language-plaintext highlighter-rouge">cookie</code> 概念</h2><p>在 <code class="language-plaintext highlighter-rouge">http</code> 里面协议是没有状态的，每一次 <code class="language-plaintext highlighter-rouge">http</code> 请求都是独立的无关的。 但是在 <code class="language-plaintext highlighter-rouge">web</code> 应用中，多个请求之间共享会话是非常必要的，所以 <code class="language-plaintext highlighter-rouge">cookie</code> 是为了辨别用户身份，进行会话跟踪而存储在 客户端上的数据。向同一个域名下发送请求，都会携带像他的 <code class="language-plaintext highlighter-rouge">Cookie</code>，服务器拿到它之后会进行解析，相当于拿到了客户端的状态</p><p>第一次客户端向服务器发送请求的时候，服务器就会通过响应头 <code class="language-plaintext highlighter-rouge">Set-Cookie</code> 向客户端种植 <code class="language-plaintext highlighter-rouge">Cookie</code>。以后客户端再向服务器发起请求的时候会带上 <code class="language-plaintext highlighter-rouge">Cookie</code> 服务器通过读取请求头中的 <code class="language-plaintext highlighter-rouge">cookie</code> 进行响应。但是这个有一点不安全，客户端可以修改 <code class="language-plaintext highlighter-rouge">Cookie</code> 的值，导致下次服务器读取到了错误客户端的 <code class="language-plaintext highlighter-rouge">Cookie</code> 的值，获取不到用户信息。为了防止 <code class="language-plaintext highlighter-rouge">cookie</code> 信息被修改，我们可以进行对 <code class="language-plaintext highlighter-rouge">cookie</code> 进行签名防止串改</p><h2 id="客户端-cookie-的设置获取删除">客户端 <code class="language-plaintext highlighter-rouge">cookie</code> 的设置获取删除</h2><p>设置 <code class="language-plaintext highlighter-rouge">cookie</code> : <code class="language-plaintext highlighter-rouge">document.cookie=newCookie</code>,一次只能只能对一个 <code class="language-plaintext highlighter-rouge">cookie</code> 进行操作，<code class="language-plaintext highlighter-rouge">newCookie</code> 后面的可选参数有 <code class="language-plaintext highlighter-rouge">;path='cookie的路径，只有路径匹配才能读到，只匹配前缀';domain='在哪一个域名下可以访问';max-age=max-age-in-seconds最大存活时间相对时间;expires=date-inGMTSting-format过期时间，绝对时间;httpOlony=true只能通过 HTTP 协议传输，不能通过 JS 访问，这也是预防 XSS 攻击的重要手段。;SameSite='Strict'</code> 或者是自定义</p><p><code class="language-plaintext highlighter-rouge">SameSite</code> 可以设置为三个值，<code class="language-plaintext highlighter-rouge">Strict</code>、<code class="language-plaintext highlighter-rouge">Lax</code> 和 <code class="language-plaintext highlighter-rouge">None</code> 。 a. 在 <code class="language-plaintext highlighter-rouge">Strict</code> 模式下，浏览器完全禁止第三方请求携带 <code class="language-plaintext highlighter-rouge">Cookie</code> 。比如请求 <code class="language-plaintext highlighter-rouge">sunseekers.cn</code> 网站只能在 <code class="language-plaintext highlighter-rouge">sunseekers.cn</code> 域名当中请求才能携带 <code class="language-plaintext highlighter-rouge">Cookie</code>，在其他网站请求都不能。</p><p>b. 在 <code class="language-plaintext highlighter-rouge">Lax</code> 模式，就宽松一点了，但是只能在 <code class="language-plaintext highlighter-rouge">get</code> 方法提交表单况或者 <code class="language-plaintext highlighter-rouge">a</code> 标签发送 <code class="language-plaintext highlighter-rouge">get</code> 请求的情况下可以携带 <code class="language-plaintext highlighter-rouge">Cookie</code>，其他情况均不能。</p><p>c. 在 <code class="language-plaintext highlighter-rouge">None</code> 模式下，也就是默认模式，请求会自动携带上 <code class="language-plaintext highlighter-rouge">Cookie</code> 。</p><p>设置 <code class="language-plaintext highlighter-rouge">cookie</code>: 原理是根据文档要求直接赋值操作,注意了，一次只能设置一个 <code class="language-plaintext highlighter-rouge">cookie</code>，不能操作多个 <code class="language-plaintext highlighter-rouge">cookie</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function setCookie(name,value,exdays){
  const now = new Date()
  now.setTime(now.getTime()+(exdays*24*60*60*1000))
  const expires = `expires=${now.toUTCString}`//toUTCString() 方法可根据世界时 (UTC) 把 Date 对象转换为字符串，并返回结果。
  console.log(expires);// 如果没有设置过期时间，默认浏览器关闭的时候清除 cookie，
  document.cookie=`${name}=${value}; ${expires}`
}
</code></pre></div></div><p>读取 <code class="language-plaintext highlighter-rouge">cookie</code>: 原理是利用 <code class="language-plaintext highlighter-rouge">cookie</code> 存储的规则，进行字符串的切割获取</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function getCookie(name){
  const cname = `${name}=`
  const cookie = document.cookie.split(';')
  for(let i=0;i&lt;cookie.length;i++){
    let cookieVal = cookie[i]
    while(cookieVal.charAt(0)===' ') cookieVal = cookieVal.substring(1)
    if(cookieVal.indexOf(cname)!=-1) return cookieVal.substring(cname.length, cookieVal.length);
  }
  return ''
}
</code></pre></div></div><p>清除 <code class="language-plaintext highlighter-rouge">cookie</code>: 原理是利用一个已经过期的时间，自动清除 <code class="language-plaintext highlighter-rouge">cookie</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function clearCookie(name){
  setCookie(name,"",-1)
}
</code></pre></div></div><p>注意了：</p><p><code class="language-plaintext highlighter-rouge">chrome</code> 浏览器在本地获取不到 <code class="language-plaintext highlighter-rouge">cookie</code>。必须在服务器上才可以。如果是本地的话，你可以放到 <code class="language-plaintext highlighter-rouge">local</code> 的 <code class="language-plaintext highlighter-rouge">www</code> 目录下面。</p><p><code class="language-plaintext highlighter-rouge">Google Chrome</code> 只支持在线网站的 <code class="language-plaintext highlighter-rouge">cookie</code> 的读写操作，对本地 <code class="language-plaintext highlighter-rouge">html</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code> 操作是禁止的。所以下面的代码如果你写在一个本地的 html 文件中，将弹出的对话框内容为空。</p><p>如果我们设置了新的 <code class="language-plaintext highlighter-rouge">cookie</code> ,旧的 <code class="language-plaintext highlighter-rouge">cookie</code> 不会被覆盖，只是将新的添加到 <code class="language-plaintext highlighter-rouge">document.cookie</code> 中.</p><h2 id="服务器设置-cookie">服务器设置 <code class="language-plaintext highlighter-rouge">cookie</code></h2><p>用 <code class="language-plaintext highlighter-rouge">node</code> 进行客户端种植 <code class="language-plaintext highlighter-rouge">cookie</code> ，实现原理很简单，就是在响应体里面加一个 <code class="language-plaintext highlighter-rouge">Set-Cookie</code> 字段就够了</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const http = require('http')
const serve = http
  .createServer((req, res) =&gt; {
    if (req.url === '/write') {
      res.setHeader('Set-Cookie', 'name=sunseekers')
      res.end('write cookie ok')
    } else if (req.url === '/read') {
      let cookie = req.headers['cookie']
      res.end(cookie)
    } else {
      res.end('not found')
    }
  })
  .listen(8888)
</code></pre></div></div><h2 id="cookie-使用注意事项"><code class="language-plaintext highlighter-rouge">cookie</code> 使用注意事项</h2><p>可能被客户端篡改，使用前验证合法性，因为数据在客户端保存，服务器没有保存 不要存储敏感数据，比如用户密码，账户余额 使用 <code class="language-plaintext highlighter-rouge">httpOnly</code> 保证安全 尽量减少 <code class="language-plaintext highlighter-rouge">cookie</code> 的体积，限制了 64k 设置正确的 <code class="language-plaintext highlighter-rouge">domain</code> 和 <code class="language-plaintext highlighter-rouge">path</code>，减少数据传输 ，只有匹配上的时候才会发送到服务器</p><h2 id="cookie-的替代方案-session"><code class="language-plaintext highlighter-rouge">cookie</code> 的替代方案 <code class="language-plaintext highlighter-rouge">session</code></h2><p>是一种记录客户端状态/数据的一种机智，只是他是保存在服务端的，客户端访问服务器的时候，服务器会以某一种形式记录在服务器上。这样比客户端会安全很多，浏览器无法修改，但是他会占用服务器的性能，如果数据量多的话</p><p>简单说就是，<code class="language-plaintext highlighter-rouge">session</code> 会生成一个唯一的表识符给客户端，服务端根据这个唯一的表识符存储数据。下次客户端通过请求头中的 <code class="language-plaintext highlighter-rouge">cookie</code> 把唯一的表识符发送给服务器，服务器根据这个唯一的表识符去读取数据</p><p>他的优点：比 <code class="language-plaintext highlighter-rouge">cookie</code> 更加安全，客户端不能够随意的修改</p><p>他的缺点：占用服务器内存，不同的服务器共享 <code class="language-plaintext highlighter-rouge">session</code> 不方便</p><h2 id="session-的替代方案-jwt"><code class="language-plaintext highlighter-rouge">session</code> 的替代方案 <code class="language-plaintext highlighter-rouge">JWT</code></h2><p><code class="language-plaintext highlighter-rouge">JWT(json web token)</code> 是在客户端和服务端通信的被认证的用户身份信息，便于获取在服务器上面的信息，不方便存储敏感信息</p><p>一旦用户完成了登陆，在接下来的每个请求中包含 <code class="language-plaintext highlighter-rouge">JWT</code>，可以用来验证用户身份以及对路由，服务和资源的访问权限进行验证。</p><p>信息交换在通信的双方之间使用 <code class="language-plaintext highlighter-rouge">JWT</code> 对数据进行编码是一种非常安全的方式，由于它的信息是经过签名的，可以确保发送者发送的信息是没有经过伪造的</p><p><code class="language-plaintext highlighter-rouge">JWT</code> 包含了使用.分隔的三部分：</p><p><code class="language-plaintext highlighter-rouge">Header</code> 头部: <code class="language-plaintext highlighter-rouge">{ "alg": "HS256", "typ": "JWT"}</code> ,使用 <code class="language-plaintext highlighter-rouge">Base64Url</code> 编码组成了 <code class="language-plaintext highlighter-rouge">JWT</code> 结构的第一部分</p><p><code class="language-plaintext highlighter-rouge">Payload</code> 负载: 服务端要给我的信息，有效期等</p><p><code class="language-plaintext highlighter-rouge">Signature</code> 签名：使用编码后的 <code class="language-plaintext highlighter-rouge">header</code> 和 <code class="language-plaintext highlighter-rouge">payload</code> 以及一个秘钥(秘钥所以服务器共享且都是一样的，不能泄漏)</p><p>使用：</p><p>当用户使用它的认证信息登陆系统之后，服务器会返回给用户一个 <code class="language-plaintext highlighter-rouge">JWT</code></p><p>用户只需要本地保存该 <code class="language-plaintext highlighter-rouge">token</code>（通常使用 <code class="language-plaintext highlighter-rouge">local storage</code>，也可以使用 <code class="language-plaintext highlighter-rouge">cookie</code> ）即可</p><p>当用户希望访问一个受保护的路由或者资源的时候，通常应该在 <code class="language-plaintext highlighter-rouge">Authorization</code> 头部使用 <code class="language-plaintext highlighter-rouge">Bearer</code> 模式添加 <code class="language-plaintext highlighter-rouge">JWT</code> ，其内容看起来是下面这样</p><p><code class="language-plaintext highlighter-rouge">Authorization: Bearer &lt;token&gt;</code></p><p>因为用户的状态在服务端的内存中是不存储的，所以这是一种无状态的认证机制</p><p>服务端的保护路由将会检查请求头 <code class="language-plaintext highlighter-rouge">Authorization</code> 中的 <code class="language-plaintext highlighter-rouge">JWT</code> 信息，如果合法，则允许用户的行为。</p><p>由于 <code class="language-plaintext highlighter-rouge">JWT</code> 是自包含的，因此减少了需要查询数据库的需要</p><p><code class="language-plaintext highlighter-rouge">JWT</code> 的这些特性使得我们可以完全依赖其无状态的特性提供数据 <code class="language-plaintext highlighter-rouge">API</code> 服务，甚至是创建一个下载流服务。 因为 <code class="language-plaintext highlighter-rouge">JWT</code> 并不使用 <code class="language-plaintext highlighter-rouge">Cookie</code> 的，所以你可以使用任何域名提供你的API服务而不需要担心跨域资源共享问题<code class="language-plaintext highlighter-rouge">（CORS）</code></p><p>其实就是相当于在请求头加一个 <code class="language-plaintext highlighter-rouge">Authorization</code> 字段，服务器对 <code class="language-plaintext highlighter-rouge">Authorization</code> 字段做一次验证，检测是否有被修改过</p><h2 id="参考资料">参考资料</h2><p><a href="https://www.cnblogs.com/wangkongming/p/3992644.html">JS 设置 cookie，删除 cookie</a> <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie">Document.cookie</a> <a href="https://github.com/mqyqingfeng/Blog/issues/157">浏览器系列之 Cookie 和 SameSite 属性</a></p></article><div style="padding-top:20px;"><hr/><p>虽然素未谋面。却已相识很久，很微妙也很知足。在逝去的岁月里，我们在某一刻，共同经历着一样的情愫</p><p>如果喜欢我的话，我们可以互相关注，相互学习的哟！互相鼓励，你的关注是我最大的动力来源</p><p>我叫 <a href="https://github.com/sunseekers">sunseekers</a> ，本名张敏，读的电子商务专业，干着前端的工作</p></div><div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="http://localhost:4000" target="_blank">sunseekers</a></li><li>本文链接：<a href="http://localhost:4000/2020/03/20/cookie/" target="_blank">http://localhost:4000/2020/03/20/cookie/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></div><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="http://localhost:4000/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2020/03/20/cookie/', clientID: 'efc20f7ef0379b54367b', clientSecret: 'a58112205486b93eb454f60f6d9d7bcbaf37e3fa', repo: 'sunseekers.github.io', owner: 'sunseekers', admin: ['sunseekers'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="http://localhost:4000/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'http://localhost:4000/assets/search_data.json', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="http://localhost:4000/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2016 <span title="sunseekers">sunseekers</span> <a href="javascript:window.scrollTo({behavior: 'smooth', top: 0})" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo({behavior: 'smooth', top: 0})" >TOP</a></li></ul><a href="https://github.com/sunseekers/sunseekers.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="首页" target="">首页</a></li><li> <a href="http://localhost:4000/categories/" title="分类" target="">分类</a></li><li> <a href="http://localhost:4000/links/" title="感谢" target="">感谢</a></li><li> <a href="http://localhost:4000/about/" title="关于" target="">关于</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="http://localhost:4000/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
