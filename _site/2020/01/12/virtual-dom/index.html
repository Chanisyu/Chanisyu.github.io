<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title> 虚拟 DOM &mdash; sunseekers</title><link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css" /><link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css" /><link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css" /><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css" /><link rel="canonical" href="http://localhost:4000/2020/01/12/virtual-dom/" /><link rel="alternate" type="application/atom+xml" title="sunseekers" href="http://localhost:4000/feed.xml" /><link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /><meta property="og:title" content="虚拟 DOM" /><meta name="keywords" content="DOM" /><meta name="og:keywords" content="DOM" /><meta name="description" content="虚拟 DOM" /><meta name="og:description" content="虚拟 DOM" /><meta property="og:url" content="http://localhost:4000/2020/01/12/virtual-dom/" /><meta property="og:site_name" content="sunseekers" /><meta property="og:type" content="article" /><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2020-01-12" /> <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="http://localhost:4000/assets/js/jquery-ui.js"></script> <script src="http://localhost:4000/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1> <a href="http://localhost:4000/" title="sunseekers" ><span class="octicon octicon-mark-github"></span> sunseekers</a ></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();" > <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页" >首页</a > <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类" >分类</a > <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="链接" >链接</a > <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于" >关于</a ></nav></div></header><style> html.dark-mode, html.dark-mode img { filter: invert(1) hue-rotate(180deg); } html.dark-mode img { opacity: 0.85; } /* 关闭了深色模式，因为布局有问题 */ #darkContainer { position: fixed; bottom: 50px; left: 100px; display: flex; display: none; } #darkContainer .text { margin-right: 8px; } #darkContainer .switch-btn { user-select: none; display: inline-block; width: 50px; border: none; height: 25px; border-radius: 50px; background: rgba(0, 0, 0, 0.25); cursor: pointer; transition: all 0.2s; position: relative; outline: none; } #darkContainer .switch-btn.switch-btn-checked { background: #1890ff; } #darkContainer .switch-btn .switch-handle { height: 20px; width: 20px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 4px; transition: all 0.2s ease-in-out; } #darkContainer .switch-btn.switch-btn-checked .switch-handle { left: calc(100% - 22px); }</style><script> let isDarkMode = localStorage.getItem('isDarkMode'); if (isDarkMode === 'true') { document.firstElementChild.classList.add('dark-mode'); } </script> <script defer> const darkContainer = document.createElement('div'); darkContainer.id = 'darkContainer'; darkContainer.innerHTML = `<span class="text">深色模式</span>`; const btnEl = document.createElement('button'); btnEl.classList.add('switch-btn'); btnEl.innerHTML = `<div class="switch-handle"></div>`; if (isDarkMode === 'true') { btnEl.classList.add('switch-btn-checked'); } btnEl.addEventListener('click', (e) => { if (btnEl.classList.contains('switch-btn-checked')) { btnEl.classList.remove('switch-btn-checked'); document.firstElementChild.classList.remove('dark-mode'); localStorage.setItem('isDarkMode', 'false'); } else { btnEl.classList.add('switch-btn-checked'); document.firstElementChild.classList.add('dark-mode'); localStorage.setItem('isDarkMode', 'true'); } }); darkContainer.append(btnEl); document.body.appendChild(darkContainer); </script></body></html><section class="collection-head small geopattern" data-pattern-id="虚拟 DOM" ><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">虚拟 DOM</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2020/01/12 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#JavaScript" title="JavaScript" >JavaScript</a > </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2253 字，约 7 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths"><article class="article-content markdown-body"><h1 id="虚拟-dom">虚拟 DOM</h1><p>简单说说虚拟 DOM</p><h2 id="真实的-dom-和框架操作-dom">真实的 DOM 和框架操作 DOM？</h2><p>virtual DOM 也就是虚拟节点，它通过js的对象模拟真实的dom中的节点，然后通过特定的render渲染成真实的dom节点，操作真实的 DOM 这种方式虽然简单粗暴，但是很明显还有一个问题就是这样无法包含节点的状态。比如它会失去当前聚焦的元素和光标，以及文本选择和页面滚动位置，这些都是页面的当前状态。</p><p>对于 <code class="language-plaintext highlighter-rouge">DOM</code> 这么多属性，其实大部分属性对于做 <code class="language-plaintext highlighter-rouge">diff</code> 是没有任何用处的，所以如果用更轻量级的 <code class="language-plaintext highlighter-rouge">JS</code> 对象来代替复杂的 <code class="language-plaintext highlighter-rouge">DOM</code> 节点，然后把对 <code class="language-plaintext highlighter-rouge">DOM</code> 的 <code class="language-plaintext highlighter-rouge">diff</code> 操作转移到 <code class="language-plaintext highlighter-rouge">JS</code> 对象，就可以避免大量对 <code class="language-plaintext highlighter-rouge">DOM</code> 的查询操作。这个更轻量级的 <code class="language-plaintext highlighter-rouge">JS</code> 对象就称为 <code class="language-plaintext highlighter-rouge">Virtual DOM</code></p><p>框架的意义在于为你掩盖底层的 <code class="language-plaintext highlighter-rouge">DOM</code> 操作，让你用更声明式的方式来描述你的目的，从而让你的代码更容易维护。没有任何框架可以比纯手动的优化 <code class="language-plaintext highlighter-rouge">DOM</code> 操作更快，因为框架的 <code class="language-plaintext highlighter-rouge">DOM</code> 操作层需要应对任何上层 <code class="language-plaintext highlighter-rouge">API</code> 可能产生的操作，它的实现必须是普适的。</p><h2 id="virtual-dom-存在的前提">Virtual DOM 存在的前提</h2><p><code class="language-plaintext highlighter-rouge">Virtual DOM</code> 存在（从我的理解来看），主要是三个方面，分别是：一个对象，两个前提，三个步骤。</p><p>一个对象指的是 <code class="language-plaintext highlighter-rouge">Virtual DOM</code> 是一个基本的 <code class="language-plaintext highlighter-rouge">JavaScript</code> 对象，也是整个 <code class="language-plaintext highlighter-rouge">Virtual DOM</code> 树的基本。</p><p>两个前提分别是 <code class="language-plaintext highlighter-rouge">JavaScript</code> 很快和直接操作 <code class="language-plaintext highlighter-rouge">DOM</code> 很慢，这是<code class="language-plaintext highlighter-rouge">Virtual DOM</code> 得以实现的两个基本前提。得益于 <code class="language-plaintext highlighter-rouge">V8</code> 引擎的出现，让 <code class="language-plaintext highlighter-rouge">JavaScript</code> 可以高效地运行，在性能上有了极大的提高。直接操作 <code class="language-plaintext highlighter-rouge">DOM</code> 的低效和 <code class="language-plaintext highlighter-rouge">JavaScript</code> 的高效相对比，为 <code class="language-plaintext highlighter-rouge">Virtual DOM</code> 的产生提供了大前提。</p><p>三个步骤指的是 <code class="language-plaintext highlighter-rouge">Virtual DOM</code> 的三个重要步骤，分别是：生成<code class="language-plaintext highlighter-rouge">Virtual DOM</code> 树、对比两棵树的差异、更新视图。</p><p><code class="language-plaintext highlighter-rouge">DOM</code> 是前端工程师最常接触的内容之一，一个 <code class="language-plaintext highlighter-rouge">DOM</code> 节点包含了很多的内容，但是一个抽象出一个 <code class="language-plaintext highlighter-rouge">DOM</code> 节点却只需要三部分：节点类型，节点属性、子节点。所以围绕这三个部分，我们可以使用 <code class="language-plaintext highlighter-rouge">JavaScript</code> 简单地实现一棵 <code class="language-plaintext highlighter-rouge">DOM</code> 树，然后给节点实现渲染方法，就可以实现虚拟节点到真是 <code class="language-plaintext highlighter-rouge">DOM</code> 的转化。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 虚拟dom type类型，props属性，children子节点
//创建一个类
class Element {
  constructor(type, props, children) {
    this.type = type
    this.props = props
    this.children = children
  }
}

//创建一个元素
function createElement() {
  return new Element(type, props, children)
}

// render 方法可以将vnode转化为真实dom
function render(eleObj) {
  // 创建一个元素
  let el = document.createElement(eleObj.type)
  for (let key in eleObj.props) {
    setAttr(el, key, eleObj.props[key])
  }
  eleObj.children.forEach(child =&gt; {
    child = (child instanceof Element) ? render(child) : document.createTextNode(child)
    el.appendChild(child)
  })
  return el
}

// 设置属性
function setAttr(node, key, value) {
  props.forEach(element =&gt; {
    switch (key) {
      case 'value': //node是一个input或者textarea
        if (node.tagName.toUpperCase() === "INPUT" || node.tagName.toUpperCase() === "TEXEAREA") {
          node.value = value
        } else {
          node.setAttribute(key, value)
        }
        break;
      case 'style':
        node.style.cssText = value
        break;
      default:
        node.setAttribute(key, value)
        break
    }
  });
}
// 渲染页面
function renderDom(el, target) {
  target.appendChild(el)
}
</code></pre></div></div><p>使用的时候 <code class="language-plaintext highlighter-rouge">createElement()</code>, <code class="language-plaintext highlighter-rouge">render()</code>, <code class="language-plaintext highlighter-rouge">renderDom()</code></p><p>比较两棵 <code class="language-plaintext highlighter-rouge">DOM</code> 树的差异是 <code class="language-plaintext highlighter-rouge">Virtual DOM</code> 算法最核心的部分，这也是我们常说的的 <code class="language-plaintext highlighter-rouge">Virtual DOM</code> 的 <code class="language-plaintext highlighter-rouge">diff</code> 算法。在比较的过程中，我们只比较同级的节点，非同级的节点不在我们的比较范围内，这样既可以满足我们的需求，又可以简化算法实现。</p><h2 id="框架的意义">框架的意义？</h2><p>框架存在的意义是什么？是提高性能？提高开发效率？亦或是其他用途，每个人对框架的理解不同，答案也不尽相同。但是不得不承认，存在框架的情况下，项目的可维护性有了极大的提高，而对于其他方面就要做出牺牲，比如性能。在上面的性能测试中，其实完全走入了一个误区，在测试中我们用到的原生的操作其实是“人为”地对操作进行优化之后的结果，而如果抛开人为优化的前提，最终的结果可能就不是这样了。<code class="language-plaintext highlighter-rouge">Virtual DOM</code> 的优势不在于单次的操作，而是在大量、频繁的数据更新下，能够对视图进行合理、高效的更新。这一点是原生操作远远无法替代的</p><p>虚拟 <code class="language-plaintext highlighter-rouge">DOM</code> 最大的优势在于抽象了原本的渲染过程，实现了跨平台的能力，而不仅仅局限于浏览器的 <code class="language-plaintext highlighter-rouge">DOM</code></p></article><div style="padding-top:20px;"><hr/><p>虽然素未谋面。却已相识很久，很微妙也很知足。在逝去的岁月里，我们在某一刻，共同经历着一样的情愫</p><p>如果喜欢我的话，我们可以互相关注，相互学习的哟！互相鼓励，你的关注是我最大的动力来源</p><p>我叫 <a href="https://github.com/sunseekers">sunseekers</a> ，本名张敏，读的电子商务专业，干着前端的工作</p></div><div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="http://localhost:4000" target="_blank">sunseekers</a></li><li>本文链接：<a href="http://localhost:4000/2020/01/12/virtual-dom/" target="_blank">http://localhost:4000/2020/01/12/virtual-dom/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></div><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="http://localhost:4000/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2020/01/12/virtual-dom/', clientID: 'efc20f7ef0379b54367b', clientSecret: 'a58112205486b93eb454f60f6d9d7bcbaf37e3fa', repo: 'sunseekers.github.io', owner: 'sunseekers', admin: ['sunseekers'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="http://localhost:4000/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'http://localhost:4000/assets/search_data.json', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="http://localhost:4000/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2016 <span title="sunseekers">sunseekers</span> <a href="javascript:window.scrollTo({behavior: 'smooth', top: 0})" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo({behavior: 'smooth', top: 0})" >TOP</a></li></ul><a href="https://github.com/sunseekers/sunseekers.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="首页" target="">首页</a></li><li> <a href="http://localhost:4000/categories/" title="分类" target="">分类</a></li><li> <a href="http://localhost:4000/links/" title="链接" target="">链接</a></li><li> <a href="http://localhost:4000/about/" title="关于" target="">关于</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="http://localhost:4000/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
