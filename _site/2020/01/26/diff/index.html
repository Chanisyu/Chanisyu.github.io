<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title> 简版 diff &mdash; sunseekers</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/vendor/primer-css/css/primer.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/css/components/collection.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/css/components/repo-card.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/css/sections/repo-list.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/css/components/boxed-group.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/css/globals/common.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/css/globals/responsive.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/css/posts/index.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/vendor/octicons/octicons/octicons.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css" /><link rel="canonical" href="http://localhost:4000/2020/01/26/diff/" /><link rel="alternate" type="application/atom+xml" title="sunseekers" href="http://localhost:4000/feed.xml" /><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/favicon.ico" /><meta property="og:title" content="简版 diff" /><meta name="keywords" content="diff" /><meta name="og:keywords" content="diff" /><meta name="description" content="diff 算法是什么" /><meta name="og:description" content="diff 算法是什么" /><meta property="og:url" content="http://localhost:4000/2020/01/26/diff/" /><meta property="og:site_name" content="sunseekers" /><meta property="og:type" content="article" /><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2020-01-26" /> <script src="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1> <a href="http://localhost:4000/" title="sunseekers" ><span class="octicon octicon-mark-github"></span> sunseekers</a ></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();" > <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页" >首页</a > <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类" >分类</a > <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="感谢" >感谢</a > <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于" >关于</a ></nav></div></header><style> html.dark-mode, html.dark-mode img { filter: invert(1) hue-rotate(180deg); } html.dark-mode img { opacity: 0.85; } /* 关闭了深色模式，因为布局有问题 */ #darkContainer { position: fixed; bottom: 50px; left: 100px; display: flex; display: none; } #darkContainer .text { margin-right: 8px; } #darkContainer .switch-btn { user-select: none; display: inline-block; width: 50px; border: none; height: 25px; border-radius: 50px; background: rgba(0, 0, 0, 0.25); cursor: pointer; transition: all 0.2s; position: relative; outline: none; } #darkContainer .switch-btn.switch-btn-checked { background: #1890ff; } #darkContainer .switch-btn .switch-handle { height: 20px; width: 20px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 4px; transition: all 0.2s ease-in-out; } #darkContainer .switch-btn.switch-btn-checked .switch-handle { left: calc(100% - 22px); }</style><script> let isDarkMode = localStorage.getItem('isDarkMode'); if (isDarkMode === 'true') { document.firstElementChild.classList.add('dark-mode'); } </script> <script defer> const darkContainer = document.createElement('div'); darkContainer.id = 'darkContainer'; darkContainer.innerHTML = `<span class="text">深色模式</span>`; const btnEl = document.createElement('button'); btnEl.classList.add('switch-btn'); btnEl.innerHTML = `<div class="switch-handle"></div>`; if (isDarkMode === 'true') { btnEl.classList.add('switch-btn-checked'); } btnEl.addEventListener('click', (e) => { if (btnEl.classList.contains('switch-btn-checked')) { btnEl.classList.remove('switch-btn-checked'); document.firstElementChild.classList.remove('dark-mode'); localStorage.setItem('isDarkMode', 'false'); } else { btnEl.classList.add('switch-btn-checked'); document.firstElementChild.classList.add('dark-mode'); localStorage.setItem('isDarkMode', 'true'); } }); darkContainer.append(btnEl); document.body.appendChild(darkContainer); </script></body></html><section class="collection-head small geopattern" data-pattern-id="简版 diff" ><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">简版 diff</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2020/01/26 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="http://localhost:4000/categories/#JavaScript" title="JavaScript" >JavaScript</a > </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 4055 字，约 12 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths"><article class="article-content markdown-body"><h1 id="diff-算法是什么">diff 算法是什么</h1><p>并不是什么高深莫测的东西，就是根据一定的规则比较两个js对象的差别。我们把比较得出来的差异叫 patch，根据 patch 去渲染更新真实的 DOM ，就实现了数据操作视图，实现局部更新</p><h2 id="虚拟-dom-转换真实-dom">虚拟 DOM 转换真实 DOM</h2><p>规则</p><p>a. 是一个js对象（虚拟DOM），我们约定对象第一个参数是type=&gt; 元素的类型，第二个参数是props=&gt; 元素的属性，第三个参数是元素的字节点=&gt; children</p><p>b. 根据前面我们创建的js对象（虚拟DOM）渲染成真实的DOM</p><p>实现 a 的步骤：</p><ol><li><p>创建一个类，类上面有约定的需要的那些参数</p></li><li><p>根据这个类的属性（参数）创建一个元素</p></li><li><p>把这个元素渲染到页面上</p></li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 1. 创建一个元素类
class Element(type,props,children){
  constructor(type,props,children){
    this.type=type
    this.props=props
    this.children=children
  }
}

// 2. 创建一个元素

function createElement() {
  return new Element(type, props, children)
}

// 3. 渲染这个元素 eleObj 就是createElement 创建的js对象
function render(eleObj) {
 // 1. 创建这个元素
 let el = document.createElement(eleObj.type)
 // 2. 给这个元素加上属性
 for(let key in eleObj.props){
    setAttr(el, key, eleObj.props[key])
 }
 // 3. 把子节点进行同样的操作
   eleObj.children.forEach(child =&gt; {
    child = (child instanceof Element) ? render(child) : document.createTextNode(child)
    el.appendChild(child)
  })
  return el
}
// 设置属性
function setAttr(node, key, value) {
  props.forEach(element =&gt; {
    switch (key) {
      case 'value': //node是一个input或者textarea
        if (node.tagName.toUpperCase() === "INPUT" || node.tagName.toUpperCase() === "TEXEAREA") {
          node.value = value
        } else {
          node.setAttribute(key, value)
        }
        break;
      case 'style':
        node.style.cssText = value
        break;
      default:
        node.setAttribute(key, value)
        break
    }
  });
}
</code></pre></div></div><p>实现 b 的步骤：</p><p>渲染到指定的元素后面</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function renderDom(el, target) {
  target.appendChild(el)
}
</code></pre></div></div><p>到这里我们就实现了一个虚拟dom 转换为真实dom。接下里就是进行diff</p><h2 id="计算出两个节点的patch-diff比较">计算出两个节点的patch （diff比较</h2><p>规则：</p><ol><li><p>返回一个patches 对象</p></li><li><p>同层比较，不越层比较</p></li></ol><p>节点类型相同，比较属性，变化属性一个补丁包{type:ATTRS,attrs:{}}</p><p>新的dom节点不存在{type:”REMOVE”,index:xx}</p><p>节点类型不同，直接采用替换模式{type:”REPLACE”,newNode}</p><p>文本变化{type:”TEXT”,text:99}</p><ol><li>深度优先遍历，根据遍历先后存放patch 对象</li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const vertualDomOld = createElement(
  'div', {
    class: 'name'
  }, [createElement('p', {
      class: 'age'
    },
    [90]
  )]
)

const vertualDomNew = createElement(
  'div', {
    class: 'name'
  }, [createElement('p', {
      class: 'age'
    },
    [90]
  )]
)
</code></pre></div></div><p>vertualDomOld 和 vertualDomNew 分别是新旧节点</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const ATTRS="ATTRS"
const REMOVE="REMOVE"
const REPLACE="REPLACE"
const TEXT="TEXT"

function diff(oldTree,newTree){
  //1. 返回一个 patches 对象
 let patches = {}
let Index = 0 // 用来记录遍历的索引，为了记录patches 对象方便
 // 2. 遍历对比两个节点
 walk(oldTree,newTree,Index,patches)
 return patches
}

function walk(oldNode,newNode,index,patches){
  const currentPatch=[]
  if(!newNode){
    // 老节点被删除了
     currentPatch.push({type:REMOVE,index})
  }else if(isString(oldNode)&amp;&amp;isString(newNode)){
    //  当前节点是字符串,是的话并且变化了就直接替换
    if(oldNode!==newNode){
     currentPatch.push({type:TEXT,text:newNode})
    }
  }else if(oldNode.type===newNode.type){
  // 1. 新老节点没有变化
    // 对比属性是否有变化,返回变化的对象
    let attrs = diffAttr(oldNode.props,newNode.props)
    // 记录变的的patch,判断attrs是不是有值
    if(Object.keys(attrs).length){
     currentPatch.push({type:ATTRS,attrs})
    }
    // 2. 如果有儿子节点，就遍历儿子节点，进行对象
    diffChildren(oldNode.children,newNode,children,patches)
    // 存放到大补丁包里面
    if(currentPatch){
      patches[index] = currentPatch
    }
  }else{
    // 说明节点被替换了
     currentPatch.push({type:REPLACE,newNode})
  }

}

// 对比属性是否有变化 diffAttr
function diffAttr(oldAttrs,newAttrs){
  let patch = {}
  // 判断老的属性和新的属性的关系，有可能存在undefined，被删除的节点
  for(let key in oldAttrs ){
    if(oldAttrs[key]!==newAttrs[key]){
      patch[key]=newAttrs[key]
    }
  }
  // 新增的新节点
    for(let key in newAttrs ){
    if(oldAttrs.hasOwnproperty(key)){
      patch[key]=newAttrs[key]
    }
  }
  return patch
}

fucntion diffChildren(oldChildren,newChilddren){
  // 比较老的第一个和新的第一个，递归调用
  oldChildren.forEach((child,idx)=&gt;{
    walk(child,newChilddren[idx],++Index,patches)
  })
}

function isString(node){
  return Object.prototype.toString.call(node)==='[object String]
}
</code></pre></div></div><h2 id="给元素打补丁重新更新视图">给元素打补丁，重新更新视图</h2><p>规则</p><ol><li>根据patches 里面的 index 找到对应需要打补丁的元素</li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let allPathes
let index = 0// 默认给哪一个打补丁
function patch(node,patches){
  allPathes=patches
  walk(node)
}
//深度先序 遍历
function walk(node){
  let currentPatch=allPathes[index++]
  // 获取当前元素的所有子元素，递归调用
  let childNodes=node.childNodes
  childNodes.forEach(child=&gt;walk(child))
  if(currentPatch){
    // 有补丁给元素打补丁
    doPatch(node,currentPatch)// 后序遍历，和找补丁方向相反
  }
}
// 更新视图
function doPatch(node,patches){
  patches.forEach(patch=&gt;{
    switch (patch.type) {
      case 'ATTRS': 
        for(let key in patch.attrs){
          let value = patch.attrs[key]
          if(value){
          setAttr(node,key,value)// 虚拟dom里面那个方法

          }else{
            node.removeAttribute(key)// 删除属性
          }
        }
        break;
      case 'TEXT':
        node.textContent=patch.text
        break;
      case 'REPLACE':
      // newNode 是一个虚拟dom，要渲染成真实dom的（Element是一个类
        let newNode = (patch.newNode instanceof Element)?render(patch.newNode):document.createTextNode(patch.newNode)

        node.parentNode.replaceChild(newNode,node)
        break;
        case "REMOVE":
        node.parentNode.remove 
      default:
        node.setAttribute(key, value)
        break
    }
  })
}
</code></pre></div></div></article><div style="padding-top:20px;"><hr/><p>虽然素未谋面。却已相识很久，很微妙也很知足。在逝去的岁月里，我们在某一刻，共同经历着一样的情愫</p><p>如果喜欢我的话，我们可以互相关注，相互学习的哟！互相鼓励，你的关注是我最大的动力来源</p><p>我叫 <a href="https://github.com/sunseekers">sunseekers</a> ，本名张敏，读的电子商务专业，干着前端的工作</p></div><div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="http://localhost:4000" target="_blank">sunseekers</a></li><li>本文链接：<a href="http://localhost:4000/2020/01/26/diff/" target="_blank">http://localhost:4000/2020/01/26/diff/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></div><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2020/01/26/diff/', clientID: 'efc20f7ef0379b54367b', clientSecret: 'a58112205486b93eb454f60f6d9d7bcbaf37e3fa', repo: 'sunseekers.github.io', owner: 'sunseekers', admin: ['sunseekers'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'http://localhost:4000/assets/search_data.json', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2016 <span title="sunseekers">sunseekers</span> <a href="javascript:window.scrollTo({behavior: 'smooth', top: 0})" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo({behavior: 'smooth', top: 0})" >TOP</a></li></ul><a href="https://github.com/sunseekers/sunseekers.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="http://localhost:4000/" title="首页" target="">首页</a></li><li> <a href="http://localhost:4000/categories/" title="分类" target="">分类</a></li><li> <a href="http://localhost:4000/links/" title="感谢" target="">感谢</a></li><li> <a href="http://localhost:4000/about/" title="关于" target="">关于</a></li><li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/sunseekers/sunseekers.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
