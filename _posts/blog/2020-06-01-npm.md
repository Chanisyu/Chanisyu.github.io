---
layout: post
title: 公共组件库从集成到发布
categories: [功能实现]
description: 公共组件库从集成到发布
keywords: 功能实现
---

# 背景
每次写代码都是去copy以前的代码，修修改改，很没意思。标准的copy工程师，想要拥有适合自己业务开发的组件库，下一次直接引用就好了

## 准备工作
使用 [storybook](https://storybook.js.org/docs/react/get-started/introduction) 书写组件文档 ，因为pc端同事用的就是这个，使用简单，上手快

安装 npx sb init

启动 npm run storybook

文档书写每一个组件文件夹内建立文件**.stories.tsx文件，用来写组件的用法；写法就和写react文件一模一样

```
import React from 'react';
import { storiesOf } from '@storybook/react' // storybook使用的库

import Cakendar from './index';

const defaultCakendar = () => (
  <div className='story-header'>Button 按钮
  <Cakendar/>
  </div>

)
storiesOf('Cakendar', module).add('Button按钮', defaultCakendar)// 显示在页面上面
```

简单的组件demo写好了

打包 tsc // 因为使用的是ts文件
进行 npm 发包

没有使用过npm发包就使用 `npm adduser`

npm 登陆 `npm login`

npm 发包 `npm publish`

### 相关配置文件

ts.config.json

```
{
  "compilerOptions": {                  /* Enable incremental compilation */
    "target": "es5",                          /* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017', 'ES2018', 'ES2019', 'ES2020', or 'ESNEXT'. */
    "module": "commonjs",                        /* Report errors in .js files. */
    "jsx": "react",                     /* Specify JSX code generation: 'preserve', 'react-native', or 'react'. */
    "declaration": true,                   /* Generates corresponding '.d.ts' file. */
    "emitDeclarationOnly": true,                   /* Concatenate and emit output to single file. */
    "outDir": "./lib/",                        /* Redirect output structure to the directory. */
    "rootDir": "./src/",          
    "strict": true,                
    "esModuleInterop": true,   
    "forceConsistentCasingInFileNames": true  /* Disallow inconsistently-cased references to the same file. */
  }
}
```

rollup.config.js 为了解决公共组件打包图片的问题

```
import typescript from '@rollup/plugin-typescript';
import commonjs from '@rollup/plugin-commonjs';
import image from '@rollup/plugin-image';
import { nodeResolve } from '@rollup/plugin-node-resolve';

export default {
  input: 'src/index.tsx',
  output: {
    dir: 'lib',
    format: 'cjs',
  },
  plugins: [
    image(),
    typescript({
      lib: ['DOM', 'ES2015'],
      target: 'es5',
      jsx: 'react',
      allowSyntheticDefaultImports: true,
    }),
    commonjs(),
    nodeResolve(),
  ],
  external: ['react', 'react-dom',],
};
```

package.json

```
{
  "name": "xhb-lib-demo",
  "version": "1.0.6",
  "description": "",
  "main": "lib/index.js",//指定入口文件
  "scripts": {
    "build": "rm -rf lib && tsc --project ts.config.json && rollup -c" // 每次打包前删除上一次打包的目录 执行tsc的时候 执行指定文件， 然后在执行rollup的命令
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@material-ui/core": "^4.11.0",
    "@types/react": "^16.9.46",
    "@types/react-dom": "^16.9.8",
    "react": "^16.13.1",
    "react-dom": "^16.13.1"
  },
  "devDependencies": {
    "@rollup/plugin-babel": "^5.2.0",
    "@rollup/plugin-commonjs": "^15.0.0",
    "@rollup/plugin-image": "^2.0.5",
    "@rollup/plugin-node-resolve": "^9.0.0",
    "@rollup/plugin-typescript": "^5.0.2",
    "rollup": "^2.26.3",
    "tslib": "^2.0.1",
    "typescript": "^3.9.7"
  }
}

```

## 开始开发

按照正常的逻辑写代码就好了。以前怎么写现在怎么写。

我们采用的是 [material](https://material-ui.com/) 集成。就是改改他的样式，改成我们想要的样子

### 遇到的问题
tsc 打包的时候没有把静态资源图片打包进去，解决问题，使用rollup.config.js解决

src文件没有index.tsx 导出文件，导致打包的lib缺少引用。使用的时候一直报错

[demo 地址](https://github.com/sunseekers/npm)